<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>Academic English</title>
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }

        html {
            /* Handle safe areas for notch devices */
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
        }

        body {
            font-family: 'Crimson Pro', Georgia, serif;
            font-size: 1rem;
            line-height: 1.6;
            color: #1e293b;
            background: #fdfbf7;
            min-height: 100vh;
            min-height: -webkit-fill-available;
            -webkit-text-size-adjust: 100%;
            -webkit-tap-highlight-color: transparent;
        }

        .app {
            max-width: 600px;
            margin: 0 auto;
            padding: 0.75rem;
            padding-bottom: calc(0.75rem + env(safe-area-inset-bottom));
        }

        /* Header */
        .header {
            margin-bottom: 1rem;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #e2e8f0;
            margin-bottom: 0.75rem;
        }

        .header h1 {
            font-size: 1rem;
            font-weight: 600;
        }

        .score {
            font-family: monospace;
            font-size: 0.8rem;
            color: #64748b;
            background: #f1f5f9;
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
        }

        /* Category Tabs */
        .category-section {
            margin-bottom: 0.6rem;
        }

        .category-label {
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #94a3b8;
            margin-bottom: 0.4rem;
            font-weight: 500;
        }

        .category-scroll {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            -ms-overflow-style: none;
            margin: 0 -0.75rem;
            padding: 0 0.75rem;
        }

        .category-scroll::-webkit-scrollbar {
            display: none;
        }

        .toggle-group {
            display: flex;
            gap: 0.35rem;
            padding-bottom: 0.4rem;
            min-width: max-content;
        }

        .toggle-btn {
            /* Min 44px touch target per Apple HIG */
            min-height: 36px;
            padding: 0.5rem 0.65rem;
            font-family: inherit;
            font-size: 0.7rem;
            border: 1px solid #e2e8f0;
            background: white;
            border-radius: 18px;
            cursor: pointer;
            color: #64748b;
            transition: all 0.15s ease;
            white-space: nowrap;
            /* Prevent zoom on double-tap */
            touch-action: manipulation;
        }

        .toggle-btn:hover {
            border-color: #94a3b8;
            background: #f8fafc;
        }

        .toggle-btn:active {
            background: #f1f5f9;
            transform: scale(0.97);
        }

        .toggle-btn.active {
            background: #1e293b;
            color: white;
            border-color: #1e293b;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 2rem 0;
        }

        .loading.hidden { display: none; }

        .spinner {
            width: 32px;
            height: 32px;
            border: 3px solid #e2e8f0;
            border-top-color: #1e293b;
            border-radius: 50%;
            margin: 0 auto 0.75rem;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .loading p {
            color: #64748b;
            font-size: 0.85rem;
        }

        /* Question Area */
        .question-area {
            animation: fadeIn 0.3s ease;
        }

        .question-area.hidden { display: none; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .sentence {
            font-size: 1.05rem;
            line-height: 1.7;
            margin-bottom: 1rem;
            padding: 1rem;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
        }

        .blank {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            padding: 2px 12px;
            border-radius: 4px;
            border-bottom: 2px solid #f59e0b;
        }

        /* Options */
        .options {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .option {
            display: flex;
            align-items: center;
            gap: 0.65rem;
            /* Min 44px touch target per Apple HIG */
            min-height: 48px;
            padding: 0.7rem 0.85rem;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.95rem;
            color: #1e293b;
            text-align: left;
            transition: all 0.15s ease;
            /* Prevent zoom on double-tap */
            touch-action: manipulation;
        }

        .option:hover:not(:disabled) {
            border-color: #94a3b8;
        }

        .option:active:not(:disabled) {
            background: #f8fafc;
            transform: scale(0.98);
        }

        .option:disabled { cursor: default; }

        .option .key {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            background: #f1f5f9;
            border-radius: 6px;
            font-family: monospace;
            font-size: 0.7rem;
            font-weight: 600;
            color: #64748b;
            flex-shrink: 0;
        }

        .option.correct {
            border-color: #10b981;
            background: #d1fae5;
        }

        .option.correct .key {
            background: #10b981;
            color: white;
        }

        .option.incorrect {
            border-color: #ef4444;
            background: #fee2e2;
        }

        .option.incorrect .key {
            background: #ef4444;
            color: white;
        }

        .option.revealed {
            border-color: #10b981;
            background: #d1fae5;
        }

        /* Feedback */
        .feedback {
            padding: 0.85rem;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            margin-bottom: 0.85rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
        }

        .feedback.hidden { display: none; }

        .feedback p {
            font-size: 0.85rem;
            color: #64748b;
            line-height: 1.55;
        }

        .explanation-list {
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid #e2e8f0;
        }

        .explanation-item {
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            font-size: 0.8rem;
            line-height: 1.5;
        }

        .explanation-item:last-child {
            margin-bottom: 0;
        }

        .explanation-item .opt-label {
            flex-shrink: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .explanation-item.correct .opt-label {
            background: #10b981;
            color: white;
        }

        .explanation-item.wrong .opt-label {
            background: #ef4444;
            color: white;
        }

        .explanation-item .opt-text {
            color: #475569;
        }

        /* Button */
        .btn-next {
            width: 100%;
            /* Min 44px touch target */
            min-height: 48px;
            padding: 0.8rem;
            background: #1e293b;
            color: #fdfbf7;
            border: none;
            border-radius: 10px;
            font-family: inherit;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
            touch-action: manipulation;
        }

        .btn-next:hover {
            background: #334155;
        }

        .btn-next:active {
            background: #475569;
            transform: scale(0.98);
        }

        .btn-next.hidden { display: none; }

        /* Small phones (iPhone SE, etc) - extra compact */
        @media (max-width: 374px) {
            .app {
                padding: 0.5rem;
            }

            .toggle-btn {
                font-size: 0.65rem;
                padding: 0.45rem 0.55rem;
            }

            .sentence {
                font-size: 0.95rem;
                padding: 0.85rem;
            }

            .option {
                font-size: 0.9rem;
                padding: 0.6rem 0.75rem;
            }
        }

        /* Tablet & Desktop */
        @media (min-width: 640px) {
            .app {
                padding: 2rem 1.5rem;
            }

            .header {
                margin-bottom: 1.5rem;
            }

            .header-top {
                padding-bottom: 1rem;
            }

            .header h1 {
                font-size: 1.25rem;
            }

            .score {
                font-size: 0.9rem;
            }

            .category-section {
                margin-bottom: 1rem;
            }

            .category-scroll {
                margin: 0;
                padding: 0;
            }

            .toggle-group {
                flex-wrap: wrap;
            }

            .toggle-btn {
                font-size: 0.8rem;
                padding: 0.5rem 0.8rem;
            }

            .sentence {
                font-size: 1.25rem;
                padding: 1.75rem;
                margin-bottom: 1.5rem;
            }

            .options {
                gap: 0.6rem;
                margin-bottom: 1.25rem;
            }

            .option {
                padding: 1rem 1.25rem;
                font-size: 1.05rem;
            }

            .feedback {
                padding: 1rem;
                margin-bottom: 1rem;
            }

            .feedback p {
                font-size: 0.95rem;
            }

            .btn-next {
                padding: 1rem;
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="app">
        <!-- Header -->
        <header class="header">
            <div class="header-top">
                <h1>Academic English</h1>
                <div class="score" id="score">0 / 0</div>
            </div>

            <!-- Vocabulary Categories -->
            <div class="category-section">
                <div class="category-label">Vocabulary</div>
                <div class="category-scroll">
                    <div class="toggle-group" id="vocabGroup">
                        <button class="toggle-btn active" data-mode="verbs">Verbs</button>
                        <button class="toggle-btn" data-mode="nouns">Nouns</button>
                        <button class="toggle-btn" data-mode="adjectives">Adjectives</button>
                        <button class="toggle-btn" data-mode="adverbs">Adverbs</button>
                        <button class="toggle-btn" data-mode="prepositions">Prepositions</button>
                        <button class="toggle-btn" data-mode="phrasal">Phrasal Verbs</button>
                        <button class="toggle-btn" data-mode="connectors">Connectors</button>
                    </div>
                </div>
            </div>

            <!-- Grammar Categories -->
            <div class="category-section">
                <div class="category-label">Grammar</div>
                <div class="category-scroll">
                    <div class="toggle-group" id="grammarGroup">
                        <button class="toggle-btn" data-mode="relative">Relative Clauses</button>
                        <button class="toggle-btn" data-mode="noun_clauses">Noun Clauses</button>
                        <button class="toggle-btn" data-mode="tenses">Tenses</button>
                        <button class="toggle-btn" data-mode="conditionals">If Clauses</button>
                        <button class="toggle-btn" data-mode="modals">Modals</button>
                        <button class="toggle-btn" data-mode="passive">Passive Voice</button>
                        <button class="toggle-btn" data-mode="quantifiers">Quantifiers</button>
                        <button class="toggle-btn" data-mode="pronouns">Pronouns</button>
                        <button class="toggle-btn" data-mode="gerunds">Gerund/Inf/Caus</button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Loading -->
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Generating question...</p>
        </div>

        <!-- Question -->
        <main class="question-area hidden" id="questionArea">
            <p class="sentence" id="sentence"></p>
            <div class="options" id="options"></div>
            <div class="feedback hidden" id="feedback">
                <p id="feedbackText"></p>
            </div>
            <button class="btn-next hidden" id="btnNext">Next →</button>
        </main>
    </div>

    <!-- Word lists -->
    <script src="words.js"></script>

    <script>
// ╔═══════════════════════════════════════════════════════════╗
// ║  CONFIG - Edit API settings here                          ║
// ╚═══════════════════════════════════════════════════════════╝

const CONFIG = {
    apiKey: 'UyFZtjZY3r5aNe1th2qtx6IBLynCc0ai',
    model: 'mistral-small-latest',
    temperature: 0.8,
    maxTokens: 1024,

    getPrompt: function(word) {
        return `You are an academic English instructor. Create ONE fill-in-the-blank question.

The correct answer MUST be: "${word}"

Requirements:
- Write a sentence (15-25 words) where "${word}" fits naturally in the blank _____
- Provide exactly 5 word options including "${word}"
- "${word}" must be the correct answer (index 0)
- Other 4 options should be plausible but wrong
- For EACH option, provide a brief explanation of why it is correct or wrong in this context

Respond with JSON only:
{
  "sentence": "Scientists _____ the data to identify patterns.",
  "options": ["analyze", "memorize", "organize", "summarize", "visualize"],
  "correctIndex": 0,
  "explanations": [
    "'Analyze' is correct because it means to examine in detail, which fits the scientific context of identifying patterns in data.",
    "'Memorize' is wrong because it means to commit to memory, which doesn't fit the context of working with data to find patterns.",
    "'Organize' is wrong because while related to data, it means to arrange systematically, not to examine for patterns.",
    "'Summarize' is wrong because it means to give a brief overview, not to examine details for patterns.",
    "'Visualize' is wrong because it means to form a mental image, which is a result of analysis, not the process itself."
  ]
}`;
    }
};

// ╔═══════════════════════════════════════════════════════════╗
// ║  APP CODE                                                 ║
// ╚═══════════════════════════════════════════════════════════╝

        let correct = 0, total = 0, currentQuestion = null, prefetched = null;
        let mode = 'verbs';

        const $ = id => document.getElementById(id);
        const loading = $('loading');
        const questionArea = $('questionArea');
        const sentence = $('sentence');
        const options = $('options');
        const feedback = $('feedback');
        const feedbackText = $('feedbackText');
        const btnNext = $('btnNext');
        const scoreEl = $('score');
        const vocabGroup = $('vocabGroup');
        const grammarGroup = $('grammarGroup');

        async function generateQuestion() {
            const list = WORDS[mode];
            const word = list[Math.floor(Math.random() * list.length)];
            const prompt = CONFIG.getPrompt(word);

            const res = await fetch('https://api.mistral.ai/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${CONFIG.apiKey}`
                },
                body: JSON.stringify({
                    model: CONFIG.model,
                    messages: [{ role: 'user', content: prompt }],
                    temperature: CONFIG.temperature,
                    max_tokens: CONFIG.maxTokens,
                    response_format: { type: 'json_object' }
                })
            });

            if (!res.ok) throw new Error(`API error: ${res.status}`);

            const data = await res.json();
            const text = data.choices[0].message.content;

            try {
                return JSON.parse(text);
            } catch {
                return JSON.parse(text.replace(/[\x00-\x1F\x7F]/g, ' '));
            }
        }

        async function loadQuestion() {
            showLoading(true);
            try {
                currentQuestion = prefetched || await generateQuestion();
                prefetched = null;
                displayQuestion();
                showLoading(false);
                generateQuestion().then(q => { prefetched = q; }).catch(() => {});
            } catch (err) {
                console.error(err);
                sentence.textContent = 'Failed to load. Refresh to try again.';
                showLoading(false);
            }
        }

        function displayQuestion() {
            sentence.innerHTML = currentQuestion.sentence.replace(/_____/g, '<span class="blank">_____</span>');

            const keys = ['A', 'B', 'C', 'D', 'E'];
            options.innerHTML = currentQuestion.options.map((opt, i) => `
                <button class="option" data-index="${i}">
                    <span class="key">${keys[i]}</span>
                    <span>${opt}</span>
                </button>
            `).join('');

            options.querySelectorAll('.option').forEach(btn => {
                btn.onclick = () => selectAnswer(+btn.dataset.index);
            });

            feedback.classList.add('hidden');
            btnNext.classList.add('hidden');
        }

        function selectAnswer(index) {
            const isCorrect = index === currentQuestion.correctIndex;
            total++;
            if (isCorrect) correct++;
            scoreEl.textContent = `${correct} / ${total}`;

            options.querySelectorAll('.option').forEach((btn, i) => {
                btn.disabled = true;
                if (i === index) btn.classList.add(isCorrect ? 'correct' : 'incorrect');
                if (i === currentQuestion.correctIndex && !isCorrect) btn.classList.add('revealed');
            });

            // Build detailed feedback with all explanations
            const keys = ['A', 'B', 'C', 'D', 'E'];
            let feedbackHTML = '';
            
            // Use new explanations array if available, fallback to single explanation
            if (currentQuestion.explanations && currentQuestion.explanations.length === 5) {
                feedbackHTML = '<div class="explanation-list">';
                currentQuestion.options.forEach((opt, i) => {
                    const isOptCorrect = i === currentQuestion.correctIndex;
                    const explanation = currentQuestion.explanations[i] || '';
                    feedbackHTML += `
                        <div class="explanation-item ${isOptCorrect ? 'correct' : 'wrong'}">
                            <span class="opt-label">${keys[i]}</span>
                            <span class="opt-text"><strong>${opt}:</strong> ${explanation}</span>
                        </div>
                    `;
                });
                feedbackHTML += '</div>';
            } else {
                // Fallback to single explanation
                feedbackHTML = `<p>${currentQuestion.explanation}</p>`;
            }
            
            feedbackText.innerHTML = feedbackHTML;
            feedback.classList.remove('hidden');
            btnNext.classList.remove('hidden');
        }

        function showLoading(show) {
            loading.classList.toggle('hidden', !show);
            questionArea.classList.toggle('hidden', show);
        }

        function handleCategoryClick(e) {
            const btn = e.target.closest('.toggle-btn');
            if (!btn) return;

            const newMode = btn.dataset.mode;
            if (mode === newMode) return;

            mode = newMode;

            // Clear all active states
            vocabGroup.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
            grammarGroup.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));

            btn.classList.add('active');
            prefetched = null;
            correct = 0;
            total = 0;
            scoreEl.textContent = '0 / 0';
            loadQuestion();
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', e => {
            if (!loading.classList.contains('hidden')) return;

            const map = { '1': 0, '2': 1, '3': 2, '4': 3, '5': 4, 'a': 0, 'b': 1, 'c': 2, 'd': 3, 'e': 4 };
            const idx = map[e.key.toLowerCase()];

            if (idx !== undefined) {
                const btn = options.querySelector(`.option[data-index="${idx}"]`);
                if (btn && !btn.disabled) selectAnswer(idx);
            }

            if (e.key === 'Enter' && !btnNext.classList.contains('hidden')) loadQuestion();
        });

        btnNext.onclick = loadQuestion;
        vocabGroup.onclick = handleCategoryClick;
        grammarGroup.onclick = handleCategoryClick;

        loadQuestion();
    </script>
</body>
</html>
